server {
    server_name dept.ltd www.dept.ltd  ;


    listen 90.156.208.239:443 ssl;


    ssl_certificate "/var/www/httpd-cert/dept.ltd_2025-12-07-10-58_39.crt";
    ssl_certificate_key "/var/www/httpd-cert/dept.ltd_2025-12-07-10-58_39.key";

    charset utf-8;

    gzip on;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/css text/xml application/javascript text/plain application/json image/svg+xml image/x-icon;
    gzip_comp_level 1;
    set $root_path /var/www/fastuser/data/www/dept.ltd/dist;

    root $root_path;
    index index.html;
    disable_symlinks if_not_owner from=$root_path;

    # Настройки для загрузки файлов
    client_max_body_size 10M;

    # Защита служебных файлов админки (должен быть первым - самый специфичный)
    location ~ ^/admin/(config|functions)\.php$ {
        deny all;
        return 403;
    }
    
    # Статические файлы админки (короткий кэш)
    location ~* ^/admin/.+\.(css|js|ico|png|jpg|jpeg|gif|svg)$ {
        expires 5m;
        add_header Cache-Control "public, max-age=300, must-revalidate";
        alias /var/www/fastuser/data/www/dept.ltd/admin/;
        try_files $uri =404;
    }

    # PHP-скрипты админки
    location ~ ^/admin/(.+\.php)$ {
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/fastuser/data/www/dept.ltd/admin/$1;
        fastcgi_index index.php;
    }

    # Админ-панель (PHP) - должен быть после обработки PHP файлов
    location /admin/ {
        alias /var/www/fastuser/data/www/dept.ltd/admin/;
        index index.php;
        try_files $uri $uri/ /admin/index.php?$args;
    }

    # JSON файлы
    location ^~ /data/ {
        alias /var/www/fastuser/data/www/dept.ltd/data/;
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
        try_files $uri =404;
    }

    # Загруженные файлы
    location ^~ /uploads/ {
        alias /var/www/fastuser/data/www/dept.ltd/uploads/;
        try_files $uri =404;
    }

    # Долгий кэш для версионированных и assets-файлов (с хешем)
    location ~* ^/assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Короткий кэш для обычных js/css (без хешей, например /js/portfolio.js)
    location ~* \.(js|css)$ {
        expires 5m;
        add_header Cache-Control "public, max-age=300, must-revalidate";
    }

    # Основной сайт (SPA - все запросы на index.html) - должен быть последним
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Скрытие версии nginx
    server_tokens off;

    include "/etc/nginx/fastpanel2-sites/fastuser/dept.ltd.includes";
    include /etc/nginx/fastpanel2-includes/*.conf;


    error_log /var/www/fastuser/data/logs/dept.ltd-frontend.error.log;
    access_log /var/www/fastuser/data/logs/dept.ltd-frontend.access.log;
}

server {
    server_name dept.ltd www.dept.ltd  ;
    listen 90.156.208.239:80;
    return 301 https://$host$request_uri;

    error_log /var/www/fastuser/data/logs/dept.ltd-frontend.error.log;
    access_log /var/www/fastuser/data/logs/dept.ltd-frontend.access.log;
}