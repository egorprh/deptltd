# Конфигурация Nginx для dev.dept.ltd
# Разместить в /etc/nginx/sites-available/dev.dept.ltd

server {
    server_name dev.dept.ltd;
    
    # Статический сайт
    root /var/www/dev.dept.ltd/dist;
    index index.html;
    
    # Основной сайт
    location / {
        try_files $uri $uri/ =404;
    }
    
    # Админ-панель (PHP)
    location /admin/ {
        alias /var/www/dev.dept.ltd/admin/;
        index index.php;
	    try_files $uri $uri/ /admin/index.php?$args;
    }

    # Защита служебных файлов админки
    location ~ ^/admin/(config|functions)\.php$ {
        deny all;
        return 403;
    }

    # Статические файлы админки (короткий кэш)
    location ~* ^/admin/.+\.(css|js|ico|png|jpg|jpeg|gif|svg)$ {
        expires 5m;
        add_header Cache-Control "public, max-age=300, must-revalidate";
        alias /var/www/dev.dept.ltd/admin/;
    }

    # PHP-скрипты админки через TCP (избегаем проблем с правами сокета)
    location ~ ^/admin/(.+\.php)$ {
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/dev.dept.ltd/admin/$1;
        fastcgi_index index.php;
    }
    
    # JSON файлы
    location ^~ /data/ {
        alias /var/www/dev.dept.ltd/data/;
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }
    
    # Загруженные файлы
    location ^~ /uploads/ {
        alias /var/www/dev.dept.ltd/uploads/;
	    try_files $uri =404;
    }
    
    # Настройки для загрузки файлов
    client_max_body_size 10M;
    
    # Долгий кэш для версионированных и assets-файлов (с хешем)
    location ~* ^/assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Короткий кэш для обычных js/css (без хешей, например /js/portfolio.js)
    location ~* \.(js|css)$ {
        expires 5m;
        add_header Cache-Control "public, max-age=300, must-revalidate";
    }
    
    # Скрытие версии nginx
    server_tokens off;

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/dev.dept.ltd/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/dev.dept.ltd/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}


server {
    if ($host = dev.dept.ltd) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name dev.dept.ltd;
    return 404; # managed by Certbot


}