# Конфигурация Nginx для продакшена
# Разместить в /etc/nginx/sites-available/dept.ltd

server {
    listen 80;
    server_name dept.ltd www.dept.ltd;
    
    # Статический сайт
    root /var/www/dept.ltd/dist;
    index index.html;
    
    # Основной сайт
    location / {
        try_files $uri $uri/ =404;
    }
    
    # Админ-панель (PHP)
    location /admin {
        alias /var/www/dept.ltd/admin;
        index index.php;
        try_files $uri $uri/ =404;
        
        # Статические файлы админки
        location ~* \.(css|js|ico|png|jpg|jpeg|gif|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # Защита служебных файлов админки
        location ~ /admin/(config|functions)\.php$ {
            deny all;
            return 403;
        }
        
        location ~ \.php$ {
            fastcgi_pass unix:/run/php/php8.3-fpm.sock;  # Системный PHP-FPM Unix сокет
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
    }
    
    # JSON файлы
    location /data {
        alias /var/www/dept.ltd/data;
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }
    
    # Загруженные файлы
    location /uploads {
        alias /var/www/dept.ltd/uploads;
    }
    
    # Настройки для загрузки файлов
    client_max_body_size 10M;
    
    # Кэширование статических файлов
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Скрытие версии nginx
    server_tokens off;
}
