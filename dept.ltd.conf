# Конфигурация Nginx для продакшена
# Разместить в /etc/nginx/sites-available/dept.ltd

server {
    listen 80;
    server_name dept.ltd www.dept.ltd;
    
    # Статический сайт
    root /var/www/dept.ltd/dist;
    index index.html;
    
    # Основной сайт
    location / {
        try_files $uri $uri/ =404;
    }
    
    # Админ-панель (PHP)
    location /admin/ {
        alias /var/www/dept.ltd/admin/;
        index index.php;
        try_files $uri $uri/ /admin/index.php?$args;
    }

    # Защита служебных файлов админки
    location ~ ^/admin/(config|functions)\.php$ {
        deny all;
        return 403;
    }

    # Статические файлы админки (короткий кэш)
    location ~* ^/admin/.+\.(css|js|ico|png|jpg|jpeg|gif|svg)$ {
        expires 5m;
        add_header Cache-Control "public, max-age=300, must-revalidate";
        alias /var/www/dept.ltd/admin/;
    }

    # PHP-скрипты админки через Unix-сокет PHP-FPM
    location ~ ^/admin/(.+\.php)$ {
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/dept.ltd/admin/$1;
        fastcgi_index index.php;
    }
    
    # JSON файлы
    location ^~ /data/ {
        alias /var/www/dept.ltd/data/;
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }
    
    # Загруженные файлы
    location ^~ /uploads/ {
        alias /var/www/dept.ltd/uploads/;
        try_files $uri =404;
    }
    
    # Настройки для загрузки файлов
    client_max_body_size 10M;
    
    # Долгий кэш для /assets/
    location ~* ^/assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Долгий кэш для файлов с хешем в имени (app-ABCDEFGH.js)
    location ~* ^/.+-[0-9A-Fa-f]{8,}\.(css|js|png|jpg|jpeg|gif|svg|ttf|otf|webp|ico)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Короткий кэш для обычных js/css (без хеша, например /js/portfolio.js)
    location ~* \.(js|css)$ {
        expires 5m;
        add_header Cache-Control "public, max-age=300, must-revalidate";
    }
    
    # Скрытие версии nginx
    server_tokens off;
}
